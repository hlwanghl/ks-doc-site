---
title: "有状态副本集"
---

有状态副本集 (StatefulSet)，是为了解决有状态服务的问题 (对应 Deployments 和 ReplicaSets 是为无状态服务而设计)，可以保证资源创建和伸缩时候的顺序。应用场景包括：

- 稳定的持久化存储，即 Pod 重新调度后还是能访问到相同的持久化数据，基于 PVC 来实现。
- 稳定的网络标志，即 Pod 重新调度后其 PodName 和 HostName 不变，基于 Headless Service（即没有 Cluster IP 的 Service ）来实现。
- 有序部署、有序扩展，即 Pod 是有顺序的，在部署或者扩展的时候要依据定义的顺序依次依次进行 (即从 0 到 N-1，在下一个 Pod 运行之前所有之前的 Pod 必须都是 Running 和 Ready 状态)，基于 init containers 来实现。
- 有序收缩、有序删除 (即从 N-1 到 0)。

本节通过以下几个方面介绍如何管理有状态副本集：

- 创建有状态副本集
- 查看有状态副本集详情
- 编辑有状态副本集
- 删除有状态副本集


## 创建有状态副本集      

首先登录 KubeSphere 控制台，访问左侧菜单栏，在 **应用负载** 菜单下，点击 **有状态副本集** 按钮进入列表页。选择不同的项目，就可以看到对应项目下面所有有状态副本集。如果是管理员登录，可以看到集群所有项目下的有状态副本集，如果是普通用户，则只能查看授权项目下的所有有状态副本集。

![有状态副本集 - 列表](/statefulset_list.png)

1. 点击右上角 **创建有状态副本集** 按钮，新建一个有状态副本集。

![创建有状态副本集 - 基本信息](/statefulset_create_1.png)

目前创建有状态副本集一共有三种方式，**页面创建**，**导入 yaml 文件** 创建，**代码模式** 创建。其中导入 yaml文件方式会自动将 yaml 文件内容填充到页面上，用户根据需要可以在页面上调整后再行创建；代码模式可以方便习惯命令行操作的人员直接在页面上编辑 yaml 文件并创建有状态副本集。

![创建有状态副本集 - 代码模式](/statefulset_create_8.png)

这里重点介绍页面创建的方式。创建时需要输入有状态副本集的名称并选择项目，确定副本数量，用户还可以根据需求填写有状态副本集的描述信息。

![创建有状态副本集 - 基本信息](/statefulset_create_2.png)

2. 在 **容器组设置页面** 用户可以根据需求对容器组进行配置。容器组可以包含一个或者多个容器，要求输入容器的名称和对应的镜像名。如果用户有更进一步的需求，可以点击 **高级选项**。高级选项中可以对 CPU 和内存的资源使用进行限定，其中 **requests** 是集群保证分配给容器的资源，**limits** 是容器可以使用的资源的上限。超过这个限定值，容器会被 kill。用户可以通过 **命令** 和 **参数** 选项自定义容器的启动命令和启动参数。**端口** 用于指定容器需要暴露的端口，端口协议可以选择 TCP 和 UDP，用户还可以指定端口与主机端口进行绑定。**环境变量** 可以指定容器内部使用的环境变量。上述配置信息填写完成以后，点击下一步。

![创建有状态副本集 - 容器组](/statefulset_create_3.png)

3. 在存储卷页面可以添加 **存储卷模板**，根据用户的配置为有状态副本集的每个容器组生成存储卷。点击 **添加存储卷模板**，填写存储卷的名称，选择存储类型，指定容量和访问模式。最后确定挂载点，并且点击挂载和确定。然后点击下一步。

![创建有状态副本集 - 存储](/statefulset_create_4.png)

4. **服务设置** 页面用于给有状态副本集创建服务，需要填写服务名称，服务端口和目标端口，目标端口对应容器组的暴露端口。用户可根据需求设置 **会话亲和性**，选择完成以后点击下一步。

![创建有状态副本集 - 服务](/statefulset_create_5.png)

5. 标签设置页用于指定有状态副本集对应的一组或者多组标签。

![创建有状态副本集 - 标签](/statefulset_create_6.png)

6. 节点选择器页面，用户可以通过指定一组或者多组键值对来指定期望运行容器组的主机。当不指定时，将会在集群内的任意满足调度条件的节点上启动符合副本数量的容器组。点击右下角的创建后，集群就会按照用户的配置创建对应的有状态副本集。

![创建有状态副本集 - 节点选择器](/statefulset_create_7.png)
 

## 查看有状态副本集详情 

* 在有状态副本集列表页，点击某个有状态副本集的名称，就可以进入到有状态副本集详情页，可以查看有状态副本集的详细信息以及有状态副本集对应的各种资源。

![有状态副本集 - 详情页1](/statefulset_read_1.png)

* 同时在本页可以通过左下角的容器组数量栏调整有状态副本集的副本数量，左上角的更多选项编辑配置文件，暂停/开启/删除有状态副本集  

![有状态副本集 - 详情页1](/statefulset_read_3.png)

* 当点击容器组列表的容器时，页面会跳转到容器组的详情页。

![有状态副本集 - 容器组详情页](/statefulset_read_2.png)

* 点击容器组详情页的容器列表中的某一容器时，会跳转到容器的详情页，可以看到容器的配置信息，对应资源以及日志。在本页，用户还可以通过左上角的 **终端** 按钮进入容器内部。

![有状态副本集 - 容器](/statefulset_read_4.png)


## 编辑有状态副本集

* 在有状态副本集的列表页和详情页的更多选项中都可以编辑对应的配置文件，编辑是在代码模式下完成的，编辑完成以后，点击右下方的更新按钮，就会按照最新的配置进行更新。

![编辑有状态副本集1](/statefulset_update_1.png)

* 在有状态副本集的详情页左上方的编辑可以对描述信息进行修改。

![编辑有状态副本集2](/statefulset_update_2.png)

## 删除有状态副本集

* 在列表页最右侧的更多选项和详情页的左上方的更多选项中都提供了有状态副本集的删除功能。

![删除有状态副本集1](/statefulset_delete_1.png)

![删除有状态副本集2](/statefulset_delete_2.png)
